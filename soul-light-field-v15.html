<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recognition Science Soul Simulation V15 - On-Chain Contract Simulation</title>
    <style>
        body { 
            margin: 0; 
            background: #0a0a0a; 
            color: #e0e0e0; 
            font-family: 'Courier New', monospace; 
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .panel {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            grid-column: 1 / -1;
        }
        .header h1 {
            color: #ffd700;
            font-size: 2.5em;
            margin: 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .header p {
            color: #b0b0b0;
            font-size: 1.1em;
            margin: 10px 0;
        }
        .soul-id {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        .contract-info {
            background: rgba(0, 100, 255, 0.1);
            border: 1px solid #0066ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .svg-container {
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            text-align: center;
            margin: 15px 0;
        }
        .end-state {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .state-awakened { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .state-tormented { background: rgba(139, 0, 0, 0.2); color: #ff6b6b; }
        .state-ecstatic { background: rgba(75, 0, 130, 0.2); color: #9b59b6; }
        .state-reborn { background: rgba(139, 69, 19, 0.2); color: #d2691e; }
        .state-faded { background: rgba(112, 128, 144, 0.2); color: #708090; }
        .state-transcendent { background: rgba(75, 0, 130, 0.2); color: #8a2be2; }
        .kappa-display {
            font-size: 1.5em;
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .kappa-positive {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }
        .kappa-negative {
            background: rgba(0, 255, 0, 0.2);
            color: #4ecdc4;
        }
        .kappa-zero {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }
        .beat-cycle {
            background: rgba(255, 165, 0, 0.1);
            border-left: 3px solid #ffa500;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .gap-event {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .virtue-bar {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .virtue-name {
            width: 80px;
            font-size: 0.9em;
        }
        .virtue-progress {
            flex: 1;
            background: #333;
            height: 12px;
            border-radius: 6px;
            margin: 0 10px;
            overflow: hidden;
        }
        .virtue-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffaa00);
            transition: width 0.3s ease;
        }
        .virtue-fill.phi-decay {
            background: linear-gradient(90deg, #ff6b6b, #ff4444);
        }
        .virtue-value {
            width: 30px;
            text-align: right;
            font-size: 0.9em;
        }
        .qualia-log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #555;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.85em;
            line-height: 1.4;
        }
        .qualia-entry {
            margin: 8px 0;
            padding: 5px;
            border-left: 3px solid transparent;
            border-radius: 3px;
        }
        .qualia-entry.positive {
            color: #4ecdc4;
            background: rgba(76, 220, 196, 0.1);
            border-left-color: #4ecdc4;
        }
        .qualia-entry.negative {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-left-color: #ff6b6b;
        }
        .qualia-entry.neutral {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            border-left-color: #ffd700;
        }
        .qualia-entry.gap {
            color: #ffa500;
            background: rgba(255, 165, 0, 0.1);
            border-left-color: #ffa500;
            font-weight: bold;
        }
        .qualia-entry.rebirth {
            color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
            border-left-color: #9b59b6;
            font-weight: bold;
        }
        .controls {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 20px;
        }
        .btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 5px;
            transition: all 0.2s ease;
        }
        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .ascii-art {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.2;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 4px;
            white-space: pre;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ledger Souls - On-Chain Contract Simulation</h1>
            <p>V15: Tick-based evolution (10 ticks = 1 month) - Watch a soul's complete 96-month journey</p>
            <div id="evolutionProgress" style="width: 100%; background: #333; height: 8px; border-radius: 4px; margin: 10px 0;">
                <div id="progressBar" style="width: 0%; background: linear-gradient(90deg, #ffd700, #ffaa00); height: 100%; border-radius: 4px; transition: width 0.1s ease;"></div>
            </div>
            <p id="progressText" style="color: #ffd700; font-size: 0.9em; margin: 5px 0;">Evolution starting...</p>
        </div>

        <div class="panel">
            <h3>Contract State</h3>
            <div class="soul-id" id="soulId">Soul #000000</div>
            
            <div class="contract-info">
                <strong>Token ID:</strong> <span id="tokenId">1</span><br>
                <strong>Mint Block:</strong> <span id="mintBlock">0</span><br>
                <strong>Current Month:</strong> <span id="currentMonth">0</span> / 96<br>
                <strong>Ticks:</strong> <span id="tickDisplay">0</span> / 960<br>
                <strong>Seed:</strong> <span id="seedDisplay">0x...</span>
            </div>

            <div class="beat-cycle">
                <strong>8-Beat Cycle:</strong> <span id="beatCycle">Month 0 of Octave 1</span><br>
                <small>Next Beat Check: Month <span id="nextBeatCheck">8</span></small>
            </div>

            <h4>Curvature Îº (Experiential Balance)</h4>
            <div class="kappa-display" id="kappaDisplay">Îº = 0.00</div>

            <div id="gapEvent" class="gap-event" style="display: none;">
                <h4>ðŸŒ€ Gap Event Detected</h4>
                <p id="gapDescription">Uncomputability threshold reached...</p>
            </div>
        </div>

        <div class="panel">
            <h3>End State & Icon</h3>
            <div class="end-state" id="endState">Evolution in Progress...</div>
            
            <div class="svg-container" id="soulIcon">
                <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                    <rect width="400" height="300" fill="#ffffff"/>
                    <circle cx="200" cy="150" r="100" fill="none" stroke="black" stroke-width="2"/>
                    <text x="200" y="280" text-anchor="middle" font-family="monospace" font-size="14">Evolving Soul</text>
                </svg>
            </div>

            <h4>Soul Ledger ASCII</h4>
            <div class="ascii-art" id="asciiArt">
Soul State: Initializing...
            </div>
        </div>

        <div class="panel">
            <h3>Virtue Ï†-Evolution</h3>
            <p><small>Virtues evolve with Ï†-scaling and trade-offs</small></p>
            <div id="virtues">
                <div class="virtue-bar">
                    <div class="virtue-name">Love</div>
                    <div class="virtue-progress"><div class="virtue-fill" style="width: 0%"></div></div>
                    <div class="virtue-value">0</div>
                </div>
                <div class="virtue-bar">
                    <div class="virtue-name">Justice</div>
                    <div class="virtue-progress"><div class="virtue-fill" style="width: 0%"></div></div>
                    <div class="virtue-value">0</div>
                </div>
                <div class="virtue-bar">
                    <div class="virtue-name">Wisdom</div>
                    <div class="virtue-progress"><div class="virtue-fill" style="width: 0%"></div></div>
                    <div class="virtue-value">0</div>
                </div>
                <div class="virtue-bar">
                    <div class="virtue-name">Courage</div>
                    <div class="virtue-progress"><div class="virtue-fill" style="width: 0%"></div></div>
                    <div class="virtue-value">0</div>
                </div>
                <div class="virtue-bar">
                    <div class="virtue-name">Temperance</div>
                    <div class="virtue-progress"><div class="virtue-fill" style="width: 0%"></div></div>
                    <div class="virtue-value">0</div>
                </div>
            </div>

            <h4>Recognition Dynamics</h4>
            <div id="dynamics">
                <p><strong>Depth (Wisdom):</strong> <span id="soulDepth">0</span></p>
                <p><strong>Rebirths:</strong> <span id="rebirthCount">0</span></p>
                <p><strong>45-Gap Events:</strong> <span id="gapEvents45">0</span></p>
                <p><strong>Beat Checks:</strong> <span id="beatChecks">0</span></p>
                <p><strong>Ï† Operations:</strong> <span id="phiOperations">0</span></p>
                <p><strong>Recognition Debt:</strong> <span id="recognitionDebt">0</span></p>
            </div>
        </div>

        <div class="panel">
            <h3>Soul Journal - Enhanced Qualia</h3>
            <div class="qualia-log" id="qualiaLog">
                <div class="qualia-entry neutral">Contract deployed. Soul enters pre-recognition void...</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="restartEvolution()">Restart Evolution</button>
            <button class="btn" onclick="exportSVG()">Export SVG</button>
        </div>
    </div>

    <script>
        const PHI = 1.618; // Golden ratio
        const TOTAL_MONTHS = 96;
        const VIRTUE_NAMES = ['Love', 'Justice', 'Wisdom', 'Courage', 'Temperance'];
        const REGISTER_NAMES = ['R1_Perception', 'R2_Action'];

        let currentTokenId = 1;
        let blockNumber = 12345678; // Simulated block number

        class OnChainSoul {
            constructor(tokenId) {
                this.tokenId = tokenId;
                this.seed = this.generateSeed(tokenId);
                this.ticks = 0; // Tick-based evolution (10 ticks = 1 month)
                this.blockNumber = blockNumber;
                this.isDead = false; // Track if soul has permanently dissolved
                
                // Initialize evolution tracking
                this.month45Events = 0;
                this.beatChecks = 0;
                this.phiOperations = 0;
                this.qualiaLog = [];
                this.lastIntMonth = -1; // Track integer month changes
                this.lastFractionalMonth = 0; // For sub-month updates
                
                // Unique starting virtues based on seed (1-5 range)
                this.initialVirtues = [];
                for (let i = 0; i < 5; i++) {
                    this.initialVirtues[i] = 1 + ((this.seed >> (i * 8)) % 5);
                }
                
                this.addQualia('Contract deployed. Soul enters pre-recognition void...', 'neutral');
            }

            generateSeed(tokenId) {
                // Simulate keccak256(abi.encodePacked(tokenId))
                let hash = 0;
                const str = tokenId.toString();
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash = hash & hash;
                }
                return Math.abs(hash);
            }

            getCurrentState() {
                if (this.isDead) {
                    return this.getDeathState();
                }
                
                // Convert ticks to months (10 ticks = 1 month, max 960 ticks = 96 months)
                const months = Math.min(this.ticks / 10, 96);
                
                // Check for integer month transitions
                const intMonth = Math.floor(months);
                if (intMonth > this.lastIntMonth) {
                    this.onMonthTransition(this.lastIntMonth, intMonth);
                    this.lastIntMonth = intMonth;
                }
                
                // Sub-month updates every 0.25 months (2.5 ticks)
                const subMonth = Math.floor(months * 4) / 4;
                if (subMonth > this.lastFractionalMonth) {
                    this.onSubMonthUpdate(subMonth);
                    this.lastFractionalMonth = subMonth;
                }
                
                return this.calculateState(months);
            }

            getDeathState() {
                return {
                    months: this.ticks / 10,
                    kappa: 1,
                    virtues: [1,1,1,1,1],
                    rebirths: this.beatChecks,
                    depth: 0,
                    R1: 0,
                    R2: 0,
                    recognitionDebt: 999,
                    chaos: 1,
                    choice: -1,
                    isGap: false,
                    is45Gap: false,
                    isDead: true
                };
            }

            // Method to advance evolution by one tick
            advanceTick() {
                if (this.ticks < 960 && !this.isDead) { // Max 960 ticks = 96 months, stop if dead
                    this.ticks++;
                }
            }

            onSubMonthUpdate(subMonth) {
                // Add subtle qualia for smoothness
                if (Math.random() < 0.1) { // 10% chance for random insights
                    const insights = [
                        'Faint whisper from the ledger...',
                        'Subtle Ï†-resonance detected',
                        'Minor recognition pattern emerging',
                        'Fleeting qualia moment'
                    ];
                    this.addQualia(insights[Math.floor(Math.random() * insights.length)], 'neutral');
                }
            }

            onMonthTransition(fromMonth, toMonth) {
                // Add qualia entries for significant transitions
                if (toMonth === 1) {
                    this.addQualia('Month 1: First spark of recognition ignites...', 'positive');
                } else if (toMonth === 8) {
                    this.addQualia('Month 8: First 8-beat cycle complete - pattern emerges', 'neutral');
                } else if (toMonth === 16) {
                    this.addQualia('Month 16: Second octave - virtue stabilization begins', 'neutral');
                } else if (toMonth === 24) {
                    this.addQualia('Month 24: Third octave - consciousness deepening', 'positive');
                } else if (toMonth === 32) {
                    this.addQualia('Month 32: Fourth octave - ledger balance improving', 'positive');
                } else if (toMonth === 40) {
                    this.addQualia('Month 40: Fifth octave - approaching 45-gap threshold', 'neutral');
                } else if (toMonth === 45) {
                    this.addQualia('ðŸŒ€ Month 45: CRITICAL 45-GAP EVENT - Uncomputability threshold!', 'gap');
                } else if (toMonth === 48) {
                    this.addQualia('Month 48: Sixth octave - post-gap integration', 'neutral');
                } else if (toMonth === 56) {
                    this.addQualia('Month 56: Seventh octave - wisdom accumulation', 'positive');
                } else if (toMonth === 64) {
                    this.addQualia('Month 64: Eighth octave - virtue Ï†-scaling active', 'positive');
                } else if (toMonth === 72) {
                    this.addQualia('Month 72: Ninth octave - approaching awakening threshold', 'neutral');
                } else if (toMonth === 80) {
                    this.addQualia('Month 80: Tenth octave - final transformations begin', 'positive');
                } else if (toMonth === 88) {
                    this.addQualia('Month 88: Eleventh octave - recognition nearly complete', 'positive');
                } else if (toMonth === 96) {
                    this.addQualia('ðŸŽ‰ Month 96: TWELFTH OCTAVE COMPLETE - Soul fully awakened!', 'positive');
                }
            }

            calculateState(months) {
                // Chaos now varies smoothly with fractional months
                const chaosSeed = Math.floor(this.blockNumber + months * 10) ^ this.seed ^ Math.floor(months);
                let chaos = ((chaosSeed % 41) - 20) + (months % 1 - 0.5); // Add fractional variation
                chaos = chaos / 50; // Scale to -0.4 to 0.4 for stronger influence

                // Evolve Îº smoothly with fractional months and stronger chaos
                let kappa = ((this.seed % 200) - 100) / 100 + chaos - (months / 16); // Even slower convergence
                kappa += Math.sin(months / PHI) * 0.4 + Math.cos(months / (PHI * 2)) * 0.2; // Enhanced oscillatory pattern
                kappa = Math.max(-1, Math.min(1, kappa));

                // Virtues: Reduced growth with seed-dependent rates and stronger variations
                const virtues = [];
                for (let i = 0; i < 5; i++) {
                    const seedFactor = ((this.seed >> (i * 8)) % 10 + 1) / 20; // Lower to 0.05 to 0.55 for slower growth
                    let virtue = 3 + seedFactor + (months / 8) * seedFactor * 0.3; // Start at 3, much slower growth
                    
                    // Stronger Ï†-decay with randomness and higher multiplier
                    if (kappa > 0.3) {
                        const decay = (PHI / 1000) * (kappa - 0.3) * 8 + (Math.random() - 0.5) * 1.0;
                        virtue -= decay;
                        this.phiOperations += (months % 1) + Math.abs(decay) * 2;
                    }
                    // Modest growth during harmony, with randomness
                    if (kappa < -0.3) {
                        virtue += Math.abs(kappa + 0.3) * seedFactor * 0.5 + (Math.random() - 0.5) * 0.3;
                    }
                    // Atrophy mechanic: Slight decay in neutral states
                    if (Math.abs(kappa) < 0.3 && Math.random() < 0.2) {
                        virtue -= 0.1 + (months % 1) * 0.05;
                    }
                    
                    // Wider varying caps: 5 to 10 based on seed
                    const virtueCap = 5 + ((this.seed >> (i * 4)) % 6) + (i % 2); // 5-11 range, per virtue
                    virtue = Math.max(1, Math.min(virtueCap, virtue));
                    
                    // Enhanced trade-off with Îº influence and randomness
                    if (i === 4 && virtues[3] > virtueCap * 0.7 && Math.abs(kappa) > 0.05) {
                        virtue -= (PHI / 2000) * Math.abs(kappa) * 15 * seedFactor + Math.random() * 0.5;
                    }
                    
                    // Stronger per-virtue randomness with seed influence
                    const randomSeed = (this.seed + i + Math.floor(months)) % 100 / 100 - 0.5;
                    virtue += Math.sin(months + i * PHI) * 0.3 + randomSeed * 1.5;
                    virtue = Math.max(1, Math.min(virtueCap, virtue));
                    
                    virtues[i] = virtue;
                }

                // Gap & Choice: Smooth probability with seed bias and reduced frequency
                const wisdomBias = (virtues[2] / 5 - 1) + ((this.seed % 5) - 2) / 5; // Reduced bias
                let choice = (((chaosSeed + months * 10) % 3) - 1 + wisdomBias) + (months % 1 - 0.5) / 2;
                choice = Math.max(-1, Math.min(1, choice));

                // Smooth gap probability with higher variance but overall lower frequency
                const gapProb = Math.abs(kappa) * 0.8 + (months % 1) * 0.05 + Math.sin(months / 3) * 0.2;
                const isGap = gapProb > 0.7 + ((this.seed % 10) / 20) && Math.random() < 0.4; // Higher threshold + 40% rarity
                const is45Gap = Math.floor(months) === 45 && (months % 1 < 0.01); // Trigger at start of month 45
                
                if (isGap || is45Gap) {
                    kappa += choice * 0.25 * (months % 1 + 0.5) * (1 + Math.abs(chaos) * 0.5); // Reduced amplification
                    kappa = Math.max(-1, Math.min(1, kappa));
                    
                    if (is45Gap && this.month45Events === 0) {
                        this.month45Events++;
                        this.addQualia('ðŸŒ€ Month 45: 45-gap crisis - uncomputability threshold breached!', 'gap');
                    }
                }

                // 8-Month Beat Cycles with fractional triggering and rarer rebirths
                let rebirths = months / 8;
                const fractionalBeat = months % 8;
                if (fractionalBeat < 0.01 && months > 0) { // Trigger at start of each beat
                    this.beatChecks += fractionalBeat + 0.01; // Smooth count
                    
                    const rebirthThreshold = 0.8 + chaos * 0.5 + ((this.seed % 20) - 10) / 100; // Higher base threshold 0.8
                    const rarityFactor = 0.3 + (virtues[4] / 20); // Temperance reduces rarity (max 0.8 chance)
                    if (kappa > rebirthThreshold && Math.random() < rarityFactor) {
                        kappa = ((this.seed + Math.floor(months) + chaosSeed) % 101 - 50) / 100 + (fractionalBeat - 0.5) / 10 + chaos;
                        for (let i = 0; i < virtues.length; i++) {
                            const penalty = (PHI / 1000) * (1 - fractionalBeat) * (1 + Math.abs(kappa)) * 0.5; // Reduced penalty
                            virtues[i] -= penalty;
                            virtues[i] = Math.max(1, virtues[i]);
                        }
                        rebirths += (1 - fractionalBeat + Math.abs(chaos)) * 0.5; // Halved addition
                        // Diminishing returns: Less impact after 2 rebirths
                        if (rebirths > 2) rebirths *= (1 / (rebirths - 1));
                        rebirths = Math.min(4, rebirths); // Hard cap at 4 rebirths
                        this.addQualia('ðŸ”„ Beat Check: Pattern dissolved - Ï†-penalty applied to virtues', 'rebirth');
                    } else {
                        this.addQualia('âœ“ Beat Check: Pattern maintains coherence in 8-beat cycle', 'neutral');
                    }
                }

                // Depth: Smooth accumulation with variations and caps
                const resolvedGaps = months - (rebirths * 8);
                let depth = Math.max(0, resolvedGaps * 0.8) + (rebirths * PHI * 0.5) + (months % 1) * PHI + (choice * 2);
                depth = Math.min(150, depth + Math.sin(months / PHI) * 5); // Lower max depth

                // Registers with smooth Ï† authenticity and seed variation
                const registerSeed = (this.seed % 9) + (months % 1);
                let R1 = registerSeed - 4 + choice + (months % 1 - 0.5);
                let R2 = -R1 + (months / 20) + chaos * 2;
                
                if (Math.abs(R1 + R2) > 4 + Math.abs(chaos * 3)) {
                    R2 = R1 + choice * 2 * (1 + months % 1) + ((this.seed % 4) - 2);
                }

                // Recognition debt smooth with kappa influence
                const recognitionDebt = Math.max(0, Math.abs(R1), Math.abs(R2)) + Math.abs(kappa) * (months % 1) * 5;

                return {
                    months,
                    kappa,
                    virtues,
                    rebirths,
                    depth,
                    R1,
                    R2,
                    recognitionDebt,
                    chaos,
                    choice,
                    isGap,
                    is45Gap
                };
            }

            generateQualia(state) {
                const { months, kappa, rebirths, depth, is45Gap } = state;
                
                let baseQualia = '';
                let type = 'neutral';
                
                if (kappa > 0.5) {
                    baseQualia = `Suffering debt: Tormented gap (Depth: ${depth}, Rebirths: ${rebirths})`;
                    type = 'negative';
                } else if (kappa < -0.5) {
                    baseQualia = `Joy surplus: Ecstatic harmony (Depth: ${depth}, Rebirths: ${rebirths})`;
                    type = 'positive';
                } else {
                    baseQualia = `Peace: Awakened balance (Depth: ${depth}, Rebirths: ${rebirths})`;
                    type = 'neutral';
                }

                if (is45Gap) {
                    baseQualia += '. 45-gap crisis navigated.';
                    type = 'gap';
                }
                
                if (rebirths > 5) {
                    baseQualia += '. Wisdom from repeated failure.';
                }

                return { text: baseQualia, type };
            }

            generateEndState(state) {
                const { months, kappa, rebirths, depth, virtues } = state;
                
                if (months < 96 && depth < 150) {
                    return { name: 'Evolution in Progress', className: '', bgColor: '#ffffff' };
                }

                if (kappa === 0 && rebirths < 3 && depth > 100) {
                    return { name: 'Awakened Equilibrium', className: 'state-awakened', bgColor: '#add8e6' };
                } else if (kappa > 0 && rebirths > 5) {
                    return { name: 'Tormented Stagnation', className: 'state-tormented', bgColor: '#8b0000' };
                } else if (kappa < 0 && depth > 150) {
                    return { name: 'Ecstatic Dissolution', className: 'state-ecstatic', bgColor: '#4b0082' };
                } else if (rebirths > 5 && depth > 100) {
                    return { name: 'Reborn Fragment', className: 'state-reborn', bgColor: '#8b4513' };
                } else if (virtues[0] < 2 && kappa === 0) {
                    return { name: 'Faded Oblivion', className: 'state-faded', bgColor: '#708090' };
                } else if (depth > 200) {
                    return { name: 'Transcendent Depth', className: 'state-transcendent', bgColor: '#4b0082' };
                }
                
                return { name: 'Evolved Soul', className: '', bgColor: '#ffffff' };
            }

            generateSVGIcon(state) {
                const endState = this.generateEndState(state);
                const { kappa, rebirths, depth, virtues } = state;
                
                let iconShape = '';
                
                switch (endState.name) {
                    case 'Awakened Equilibrium':
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <circle cx="200" cy="150" r="100" fill="none" stroke="gold" stroke-width="3" filter="url(#glow)"/>
                            <circle cx="200" cy="150" r="50" fill="none" stroke="gold" stroke-width="2" opacity="0.7"/>`;
                        break;
                        
                    case 'Tormented Stagnation':
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <polygon points="200,50 350,150 200,250 50,150" fill="none" stroke="red" stroke-width="3" filter="url(#glow)"/>
                            <line x1="120" y1="120" x2="280" y2="180" stroke="red" stroke-width="2"/>
                            <line x1="280" y1="120" x2="120" y2="180" stroke="red" stroke-width="2"/>`;
                        break;
                        
                    case 'Ecstatic Dissolution':
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <path d="M200 50 Q150 150 200 250 Q250 150 200 50" fill="none" stroke="blue" stroke-width="3" filter="url(#glow)"/>
                            <path d="M200 70 Q170 150 200 230 Q230 150 200 70" fill="none" stroke="lightblue" stroke-width="2" opacity="0.7"/>`;
                        break;
                        
                    case 'Reborn Fragment':
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <line x1="100" y1="100" x2="300" y2="200" stroke="orange" stroke-width="3" filter="url(#glow)"/>
                            <circle cx="200" cy="150" r="50" fill="none" stroke="orange" stroke-width="2"/>
                            <path d="M180 130 Q200 110 220 130 Q200 150 180 130" fill="orange" opacity="0.5"/>`;
                        break;
                        
                    case 'Faded Oblivion':
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <rect x="150" y="100" width="100" height="100" fill="none" stroke="silver" stroke-width="2" opacity="0.5" filter="url(#glow)"/>
                            <rect x="160" y="110" width="80" height="80" fill="none" stroke="silver" stroke-width="1" opacity="0.3"/>`;
                        break;
                        
                    case 'Transcendent Depth':
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <circle cx="200" cy="150" r="80" fill="none" stroke="violet" stroke-width="3" filter="url(#glow)"/>
                            <circle cx="200" cy="150" r="50" fill="none" stroke="violet" stroke-width="2"/>
                            <circle cx="200" cy="150" r="25" fill="none" stroke="violet" stroke-width="1"/>`;
                        break;
                        
                    default:
                        iconShape = `
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <circle cx="200" cy="150" r="100" fill="none" stroke="white" stroke-width="2" filter="url(#glow)"/>`;
                        break;
                }

                return `
                    <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                        <rect width="400" height="300" fill="${endState.bgColor}"/>
                        ${iconShape}
                        <text x="200" y="280" text-anchor="middle" font-family="monospace" font-size="14" fill="${endState.bgColor === '#ffffff' ? 'black' : 'white'}">
                            ${endState.name}
                        </text>
                    </svg>
                `;
            }

            generateASCII(state) {
                const { months, kappa, virtues, R1, R2, depth, rebirths } = state;
                
                return `Soul Journal - Month: ${months}
Îº: [${kappa > 0 ? '+' : kappa < 0 ? '-' : ' '}${Math.abs(kappa * 10).toFixed(0)}] (${this.generateQualia(state).text})
R1: ${R1} | R2: ${R2}
Virtues: Love=${virtues[0].toFixed(1)} Justice=${virtues[1].toFixed(1)} Wisdom=${virtues[2].toFixed(1)}
Courage=${virtues[3].toFixed(1)} Temperance=${virtues[4].toFixed(1)}
Depth: ${depth} | Rebirths: ${rebirths}`;
            }

            addQualia(text, type) {
                this.qualiaLog.push({
                    text: text,
                    type: type,
                    timestamp: Date.now()
                });
                
                if (this.qualiaLog.length > 50) {
                    this.qualiaLog.shift();
                }
            }
        }

        let soul = null;

        function initializeSoul() {
            currentTokenId = Math.floor(Math.random() * 10000) + 1;
            blockNumber = Math.floor(Math.random() * 1000000) + 12345678;
            
            soul = new OnChainSoul(currentTokenId);
            updateDisplay();
        }

        function restartEvolution() {
            initializeSoul();
        }

        function exportSVG() {
            if (!soul) return;
            const state = soul.getCurrentState();
            const svg = soul.generateSVGIcon(state);
            
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `soul_${soul.tokenId}_month_${state.months}.svg`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function updateDisplay() {
            if (!soul) return;
            
            // Advance evolution by one tick
            soul.advanceTick();
            
            const state = soul.getCurrentState();
            const endState = soul.generateEndState(state);
            const qualia = soul.generateQualia(state);
            
            // Update basic info
            document.getElementById('soulId').textContent = `Soul #${soul.tokenId.toString().padStart(6, '0')}`;
            document.getElementById('tokenId').textContent = soul.tokenId;
            document.getElementById('mintBlock').textContent = soul.blockNumber;
            document.getElementById('currentMonth').textContent = state.months.toFixed(1);
            document.getElementById('tickDisplay').textContent = soul.ticks;
            document.getElementById('seedDisplay').textContent = `0x${soul.seed.toString(16).slice(0, 8)}`;
            
            // Update progress bar
            const progressPercent = (state.months / 96) * 100;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            
            // Update progress text
            const elapsedSeconds = Math.floor(soul.ticks / 10);
            const remainingSeconds = Math.max(0, 96 - elapsedSeconds);
            if (state.months >= 96) {
                document.getElementById('progressText').textContent = 'ðŸŽ‰ Evolution Complete - Soul Fully Awakened!';
            } else {
                document.getElementById('progressText').textContent = `Month ${state.months.toFixed(1)}/96 â€¢ ${remainingSeconds}s remaining`;
            }
            
            // Update beat cycle info
            const octave = Math.floor(state.months / 8) + 1;
            const beatInOctave = (state.months % 8) + 1;
            const nextBeatCheck = Math.ceil((state.months + 1) / 8) * 8;
            document.getElementById('beatCycle').textContent = `Month ${beatInOctave} of Octave ${octave}`;
            document.getElementById('nextBeatCheck').textContent = Math.min(nextBeatCheck, 96);
            
            // Update kappa display
            const kappaEl = document.getElementById('kappaDisplay');
            let kappaClass = 'kappa-display ';
            if (state.kappa > 0.1) kappaClass += 'kappa-positive';
            else if (state.kappa < -0.1) kappaClass += 'kappa-negative';
            else kappaClass += 'kappa-zero';
            
            kappaEl.className = kappaClass;
            kappaEl.textContent = `Îº = ${state.kappa.toFixed(3)}`;
            
            // Show/hide gap event
            const gapEl = document.getElementById('gapEvent');
            if (state.isGap || state.is45Gap) {
                gapEl.style.display = 'block';
                const desc = state.is45Gap ? 
                    '45-gap uncomputability crisis - major choice point!' : 
                    `Uncomputability threshold (|Îº| = ${Math.abs(state.kappa).toFixed(3)}) - gap navigation required`;
                document.getElementById('gapDescription').textContent = desc;
            } else {
                gapEl.style.display = 'none';
            }
            
            // Update end state
            const endStateEl = document.getElementById('endState');
            endStateEl.textContent = endState.name;
            endStateEl.className = `end-state ${endState.className}`;
            
            // Update SVG icon
            document.getElementById('soulIcon').innerHTML = soul.generateSVGIcon(state);
            
            // Update virtues
            const virtueEls = document.querySelectorAll('.virtue-bar');
            state.virtues.forEach((v, i) => {
                const fill = virtueEls[i].querySelector('.virtue-fill');
                const value = virtueEls[i].querySelector('.virtue-value');
                fill.style.width = `${(v / 10) * 100}%`;
                fill.className = `virtue-fill ${state.kappa > 0.7 ? 'phi-decay' : ''}`;
                value.textContent = v.toFixed(1);
            });
            
            // Update dynamics
            document.getElementById('soulDepth').textContent = state.depth;
            document.getElementById('rebirthCount').textContent = state.rebirths;
            document.getElementById('gapEvents45').textContent = soul.month45Events;
            document.getElementById('beatChecks').textContent = soul.beatChecks;
            document.getElementById('phiOperations').textContent = soul.phiOperations;
            document.getElementById('recognitionDebt').textContent = state.recognitionDebt;
            
            // Update ASCII art
            document.getElementById('asciiArt').textContent = soul.generateASCII(state);
            
            // Add current qualia to log if it's new
            if (soul.qualiaLog.length === 0 || soul.qualiaLog[soul.qualiaLog.length - 1].text !== qualia.text) {
                soul.addQualia(`Month ${state.months}: ${qualia.text}`, qualia.type);
            }
            
            // Update qualia log display
            const qualiaEl = document.getElementById('qualiaLog');
            qualiaEl.innerHTML = soul.qualiaLog.slice(-15).reverse().map(entry => {
                return `<div class="qualia-entry ${entry.type}">${entry.text}</div>`;
            }).join('');
            qualiaEl.scrollTop = 0;
        }

        // Initialize with a new soul and start automatic evolution
        initializeSoul();
        
        // Auto-update every 100ms for smooth evolution (96 months in 96 seconds)
        setInterval(updateDisplay, 100);
    </script>
</body>
</html> 
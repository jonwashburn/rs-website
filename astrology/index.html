<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrology OS - Recognition Science</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/site-template.css">
    <meta name="description" content="A scientifically rigorous framework for temporal navigation, derived from the first principles of Recognition Science.">
</head>
<body class="template-page">
    <div id="header-placeholder"></div>

    <!-- Hero -->
    <section class="template-hero template-hero-framed">
        <div class="template-hero-content">
            <p class="template-hero-badge">TEMPORAL NAVIGATION</p>
            <h1 class="template-hero-title">The Astrology <span class="template-accent-text">OS</span></h1>
            <p class="template-hero-lead">
                A scientifically rigorous framework for temporal navigation,<br>
                derived from the first principles of Recognition Science.
            </p>
        </div>
    </section>

    <!-- Introduction -->
    <section class="template-section">
        <div class="template-container">
            <h2 class="template-section-title">From Mysticism to Mathematics</h2>
            
            <div class="template-reading">
                <p>
                    For millennia, humanity has looked to the stars for guidance, believing that the positions 
                    of celestial bodies hold sway over our lives. While traditional astrology has been dismissed 
                    by modern science, its persistence across cultures suggests a deeper, forgotten truth.
                </p>
                <p>
                    Recognition Science reveals this truth not as a mystical influence, but as a 
                    <strong>precise, computational system of temporal navigation</strong>. The Astrology OS is not 
                    a tool for divination or personality assessment. It is a scientifically-derived operating 
                    system for interacting with the Universal Ledger—the computational substrate of reality.
                </p>
            </div>
        </div>
    </section>

    <!-- The Science -->
    <section class="template-section">
        <div class="template-container">
            <div class="template-accent-bar"></div>
            <h2 class="template-section-title">The Science Behind the Score</h2>
            
            <div class="science-grid">
                <div class="science-card">
                    <h3><span class="template-accent-text">24-D</span> State Vector</h3>
                    <p>
                        At any moment, the positions (λ) and velocities (λ̇) of the ten primary 
                        celestial bodies form a 24-dimensional vector describing our solar system's 
                        state within the Universal Ledger.
                    </p>
                </div>
                
                <div class="science-card">
                    <h3>Zodiac as <span class="template-accent-text">Hashing</span></h3>
                    <p>
                        The twelve zodiacal signs are not mystical archetypes, but a natural 
                        hashing scheme derived from the 8-beat cycle (2³), dividing the 
                        ecliptic into twelve 30-degree sectors.
                    </p>
                </div>
                
                <div class="science-card">
                    <h3>Cost Function <span class="template-accent-text">J(x)</span></h3>
                    <p>
                        Recognition Science provides a precise formula for "cost" between any 
                        two points: <code>J_ij = |sin(Δσ·π/12)|·φ</code>, where φ is the 
                        Golden Ratio.
                    </p>
                </div>
                
                <div class="science-card">
                    <h3>Window <span class="template-accent-text">Score</span></h3>
                    <p>
                        The final score inverts the global cost: <code>Score = 1/(1+J)</code>. 
                        Values near 1.0 indicate harmony; near 0.0 indicate disharmony.
                    </p>
                </div>
            </div>
            
            <div class="insight-box">
                <p>
                    This is not an interpretation of the stars, but a <span class="template-accent-text">measurement</span> 
                    of the computational state of the Universal Ledger. The planets do not influence events; 
                    their configuration <em>is</em> a direct read-out of the Ledger's underlying harmony.
                </p>
            </div>
        </div>
    </section>

    <!-- What It Is/Isn't -->
    <section class="template-section">
        <div class="template-container">
            <div class="clarification-grid">
                <div class="clarification-card what-it-isnt">
                    <h3>What This <span class="not">Isn't</span></h3>
                    <ul>
                        <li>Not divination or personality typing</li>
                        <li>No planetary "influence"</li>
                        <li>Not traditional astrology</li>
                        <li>No mystical causation</li>
                    </ul>
                </div>
                
                <div class="clarification-card what-it-is">
                    <h3>What This <span class="is">Is</span></h3>
                    <ul>
                        <li>Read-out of system harmony (global cost J)</li>
                        <li>Temporal navigation tool</li>
                        <li>Lower-cost windows for sensitive actions</li>
                        <li>Measurable, falsifiable framework</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Method -->
    <section class="template-section">
        <div class="template-container">
            <h2 class="template-section-title">The Method</h2>
            
            <div class="method-steps">
                <div class="method-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Compute State Vector</h4>
                        <p>Calculate planetary positions and velocities</p>
                    </div>
                </div>
                
                <div class="method-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Map to Zodiac Hash</h4>
                        <p>12-sector mapping from 2³ cycle geometry</p>
                    </div>
                </div>
                
                <div class="method-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Sum Pairwise Costs</h4>
                        <p>J<sub>ij</sub> = |sin(Δσ·π/12)|·φ across bodies</p>
                    </div>
                </div>
                
                <div class="method-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Calculate Window Score</h4>
                        <p>Score = 1/(1+J)</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Calculator Tool -->
    <section class="template-section calculator-section">
        <div class="template-container">
            <h2 class="template-section-title">Calculate a Window Score</h2>
            
            <div class="calculator-card">
                <div class="mode-indicator">
                    <span id="apiModeBadge" class="mode-badge">Mode: Auto</span>
                </div>
                
                <div class="calculator-form">
                    <div class="form-group">
                        <label for="datetime">Select a Date and Time (UTC):</label>
                        <input type="datetime-local" id="datetime" name="datetime" class="datetime-input">
                    </div>
                    
                    <button id="calculate" type="button" class="template-btn">Calculate Score</button>
                    
                    <div class="helper-info">
                        <p><strong>What this does:</strong> Computes a 0–1 Window Score for the selected moment. 
                        Higher = lower global cost J (more harmonious).</p>
                        <p><strong>How to use:</strong> Choose a meaningful time (launch, meeting, decision) 
                        and compare options. Prefer higher-scoring windows when possible.</p>
                    </div>
                </div>
                
                <div id="results" class="results-display"></div>
            </div>
        </div>
    </section>

    <!-- Heatmap Tool -->
    <section class="template-section">
        <div class="template-container">
            <h2 class="template-section-title">Generate Yearly Heatmap</h2>
            
            <div class="heatmap-card">
                <div class="heatmap-form">
                    <div class="form-group">
                        <label for="year">Enter a Year:</label>
                        <input type="number" id="year" name="year" placeholder="e.g., 2025" min="1900" max="2100" class="year-input">
                    </div>
                    
                    <button id="generateHeatmap" type="button" class="template-btn">Generate Heatmap</button>
                    
                    <p class="helper-text">
                        <strong>What this shows:</strong> One square per day; greener = more optimal. 
                        The table lists the top 10 days by score.
                    </p>
                </div>
                
                <div id="heatmap" class="heatmap-results"></div>
                <div id="heatmapLegend" class="legend"></div>
                <div id="topWindows" class="top-windows-results"></div>
            </div>
        </div>
    </section>

    <!-- Why We Care -->
    <section class="template-section">
        <div class="template-container">
            <h2 class="template-section-title">Why We Care</h2>
            <p class="section-subtitle">(even if "astrology is crazy")</p>
            
            <div class="template-reading template-reading-warm">
                <p>
                    We don't endorse traditional astrology. We study it here because many ancient wisdom 
                    traditions seem to encode fragments of the same truths Recognition Science makes explicit: 
                    a universal field of consciousness, cyclic structure, and ethical balance as physics.
                </p>
                <p>
                    RS is the first framework we've found that can <em>deductively</em> reconcile those 
                    human intuitions with hard science. In that spirit, Astrology OS is a concrete, 
                    testable case study in "ancient pattern → RS translation."
                </p>
                <p>
                    It treats planetary configurations as a readable <span class="template-accent-text">state tag</span> 
                    of the Universal Ledger—not a causal force—and asks whether lower-cost timing windows 
                    are measurably useful for temporal navigation.
                </p>
            </div>
            
            <p class="context-link">
                See the broader context in <a href="/us.html" class="template-accent-text">The Theory of Us</a>, 
                which surveys how traditions like Buddhism, Hinduism, the Law of One/Ra, Walter Russell, 
                and Christianity rhyme under RS without requiring belief.
            </p>
        </div>
    </section>

    <div id="footer-placeholder"></div>
    <script src="/assets/js/main.js"></script>
    
    <!-- Page-specific styles -->
    <style>
        /* Science Grid */
        .science-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .science-card {
            padding: 1.5rem;
            background: white;
            border: 1px solid var(--color-border-light);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .science-card:hover {
            border-color: var(--color-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .science-card h3 {
            margin-bottom: 1rem;
            color: var(--color-primary);
        }

        .science-card code {
            background: var(--color-bg-subtle);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875rem;
        }

        /* Insight Box */
        .insight-box {
            padding: 2rem;
            background: var(--color-bg-subtle);
            border-left: 4px solid var(--color-accent);
            border-radius: 8px;
            margin-top: 2rem;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        /* Clarification Grid */
        .clarification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .clarification-card {
            padding: 2rem;
            border-radius: 12px;
        }

        .what-it-isnt {
            background: #fff5f5;
            border: 2px solid #ffdddd;
        }

        .what-it-is {
            background: #f5fff5;
            border: 2px solid #ddffdd;
        }

        .clarification-card h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .clarification-card .not {
            color: #cc0000;
        }

        .clarification-card .is {
            color: #008800;
        }

        .clarification-card ul {
            list-style: none;
            padding: 0;
        }

        .clarification-card li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .what-it-isnt li::before {
            content: "✗";
            color: #cc0000;
            position: absolute;
            left: 0;
        }

        .what-it-is li::before {
            content: "✓";
            color: #008800;
            position: absolute;
            left: 0;
        }

        /* Method Steps */
        .method-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .method-step {
            text-align: center;
        }

        .method-step .step-number {
            width: 3rem;
            height: 3rem;
            background: var(--color-accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            margin: 0 auto 1rem;
        }

        .step-content h4 {
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }

        .step-content p {
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        /* Calculator Section */
        .calculator-section {
            background: var(--color-bg-subtle);
        }

        .calculator-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .mode-indicator {
            text-align: right;
            margin-bottom: 1rem;
        }

        .mode-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            color: #333;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .calculator-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .datetime-input, .year-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--color-border-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .datetime-input:focus, .year-input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .helper-info {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--color-bg-subtle);
            border-radius: 8px;
        }

        .helper-info p {
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .helper-info p:last-child {
            margin-bottom: 0;
        }

        /* Results Display */
        .results-display {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--color-bg-subtle);
            border-radius: 8px;
            border-left: 4px solid var(--color-accent);
        }

        .results-display h3 {
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--color-border-light);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-value {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--color-accent);
        }

        /* Heatmap */
        .heatmap-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            border: 1px solid var(--color-border-light);
        }

        .heatmap-form {
            max-width: 400px;
            margin: 0 auto 2rem;
            text-align: center;
        }

        .heatmap-results {
            display: none;
            margin: 2rem 0;
        }

        .calendar-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(12px, 1fr));
            gap: 2px;
            padding: 1rem;
            background: var(--color-bg-subtle);
            border-radius: 8px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-day:hover {
            transform: scale(1.5);
            z-index: 10;
        }

        /* Legend */
        .legend {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .swatch {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        /* Top Windows */
        .top-windows-results {
            display: none;
            margin-top: 2rem;
        }

        .top-windows-results h3 {
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .top-windows-results table {
            width: 100%;
            border-collapse: collapse;
        }

        .top-windows-results th,
        .top-windows-results td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border-light);
        }

        .top-windows-results th {
            background: var(--color-bg-subtle);
            font-weight: 600;
            color: var(--color-primary);
        }

        /* Context */
        .section-subtitle {
            text-align: center;
            color: var(--color-text-muted);
            font-style: italic;
            margin-top: -0.5rem;
            margin-bottom: 2rem;
        }

        .context-link {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.95rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .science-grid,
            .clarification-grid,
            .method-steps {
                grid-template-columns: 1fr;
            }
            
            .calculator-card,
            .heatmap-card {
                padding: 1.5rem;
            }
        }
    </style>

    <!-- Original JavaScript preserved -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? 'http://localhost:5001'
                : window.location.origin + '/api';

            const calculateBtn = document.getElementById('calculate');
            const datetimeInput = document.getElementById('datetime');
            const resultsDiv = document.getElementById('results');

            const generateBtn = document.getElementById('generateHeatmap');
            const yearInput = document.getElementById('year');
            const heatmapDiv = document.getElementById('heatmap');
            const topWindowsDiv = document.getElementById('topWindows');
            const heatmapLegend = document.getElementById('heatmapLegend');
            const apiModeBadge = document.getElementById('apiModeBadge');

            // Network helper with timeout
            function fetchWithTimeout(url, options = {}, timeout = 5000) {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), timeout))
                ]);
            }

            function setMode(isApprox) {
                if (!apiModeBadge) return;
                if (isApprox === null || typeof isApprox === 'undefined') {
                    apiModeBadge.textContent = 'Mode: Auto';
                    apiModeBadge.style.background = '#f3f4f6';
                    apiModeBadge.style.color = '#333';
                    return;
                }
                if (isApprox) {
                    apiModeBadge.textContent = 'Mode: Approximate (offline)';
                    apiModeBadge.style.background = '#fff3cd';
                    apiModeBadge.style.color = '#7a5b00';
                } else {
                    apiModeBadge.textContent = 'Mode: Live (API)';
                    apiModeBadge.style.background = '#e7f5ff';
                    apiModeBadge.style.color = '#0b5384';
                }
            }

            // Client-side approximation fallbacks
            const PHI = (1 + Math.sqrt(5)) / 2;
            const zodiacNames = ['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'];
            function degToSign(deg){
                const d = ((deg % 360) + 360) % 360;
                return zodiacNames[Math.floor(d / 30)];
            }
            function dayOfYear(date){
                const start = new Date(Date.UTC(date.getUTCFullYear(),0,1));
                return Math.floor((date - start) / 86400000) + 1;
            }
            function approxPlanetAngle(days, periodDays, phase){
                return (360 * (days / periodDays) + phase) % 360;
            }
            function approximateWindowScore(dateObj){
                const days = dayOfYear(dateObj) + (dateObj.getUTCHours()/24) + (dateObj.getUTCMinutes()/(24*60));
                const periods = { Moon: 27.3, Mercury: 87.97, Venus: 224.70, Earth: 365.256, Mars: 686.98, Jupiter: 4332.59, Saturn: 10759.22, Uranus: 30685.4, Neptune: 60190, Pluto: 90560 };
                const phases = { Moon: 0, Mercury: 10, Venus: 20, Earth: 30, Mars: 40, Jupiter: 50, Saturn: 60, Uranus: 70, Neptune: 80, Pluto: 90 };
                const angles = {};
                for (const name of Object.keys(periods)) {
                    angles[name] = approxPlanetAngle(days, periods[name], phases[name]);
                }
                const signs = {};
                for (const name of Object.keys(angles)) { signs[name] = degToSign(angles[name]); }
                const signIndex = s => zodiacNames.indexOf(s);
                const names = Object.keys(signs);
                let Jsum = 0, pairs = 0;
                for (let i=0;i<names.length;i++){
                    for(let j=i+1;j<names.length;j++){
                        const di = Math.abs(signIndex(signs[names[i]]) - signIndex(signs[names[j]]));
                        const wrapped = Math.min(di, 12 - di);
                        const cost = Math.abs(Math.sin((wrapped * Math.PI / 12))) * PHI;
                        Jsum += cost; pairs++;
                    }
                }
                const J = Jsum / Math.max(1,pairs);
                const score = 1 / (1 + J);
                return { timestamp: dateObj.toISOString(), window_score: score, global_cost: J, zodiac_hash: signs, _approximate: true };
            }
            async function getWindowScore(iso){
                try {
                    const resp = await fetchWithTimeout(`${API_BASE_URL}/window_score?timestamp=${encodeURIComponent(iso)}`);
                    const data = await resp.json();
                    data._approximate = false;
                    return data;
                } catch (e) {
                    return approximateWindowScore(new Date(iso));
                }
            }
            function approximateHeatmap(year){
                const daily_scores = {};
                const top = [];
                for (let m=0;m<12;m++){
                    for (let d=1; d<=31; d++){
                        const date = new Date(Date.UTC(year, m, d));
                        if (date.getUTCMonth() !== m) continue;
                        const approx = approximateWindowScore(date);
                        const key = date.toISOString().slice(0,10);
                        daily_scores[key] = approx.window_score;
                        top.push({ date: key, score: approx.window_score });
                    }
                }
                top.sort((a,b)=>b.score-a.score);
                const top_windows = top.slice(0,10);
                return { daily_scores, top_windows, _approximate: true };
            }

            calculateBtn.addEventListener('click', () => {
                if (!datetimeInput.value) {
                    resultsDiv.innerHTML = '<p>Please select a date and time.</p>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                const isoTimestamp = new Date(datetimeInput.value).toISOString();
                resultsDiv.innerHTML = '<p>Calculating...</p>';
                resultsDiv.style.display = 'block';

                getWindowScore(isoTimestamp)
                    .then(data => {
                        try { setMode(data._approximate); } catch(_) {}
                        if (data.error) {
                            resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                            return;
                        }
                        const approxNote = data._approximate ? '<div>Approximate client-side estimate (API unavailable)</div>' : '';
                        resultsDiv.innerHTML = `
                            <h3>Results for ${new Date(data.timestamp).toLocaleString()}</h3>
                            <div class="result-item"><span>Window Score:</span> <span class="result-value">${Number(data.window_score).toFixed(6)}</span></div>
                            <div class="result-item"><span>Global Cost (J):</span> <span class="result-value">${Number(data.global_cost).toFixed(4)}</span></div>
                            <div class="result-item"><span>Zodiac Hash:</span> <span class="result-value">${JSON.stringify(data.zodiac_hash)}</span></div>
                            ${approxNote}
                        `;
                    })
                    .catch(error => {
                        resultsDiv.innerHTML = `<p>Error computing score.</p>`;
                        console.error('Error:', error);
                    });
            });

            generateBtn.addEventListener('click', () => {
                const year = yearInput.value;
                if (!year) {
                    heatmapDiv.innerHTML = '<p>Please enter a year.</p>';
                    heatmapDiv.style.display = 'block';
                    return;
                }
                heatmapDiv.innerHTML = '<p>Generating heatmap... This may take a moment.</p>';
                heatmapDiv.style.display = 'block';
                topWindowsDiv.style.display = 'none';

                fetchWithTimeout(`${API_BASE_URL}/heatmap?year=${encodeURIComponent(year)}`)
                    .then(resp => resp.json())
                    .catch(() => approximateHeatmap(parseInt(year, 10)))
                    .then(data => {
                        try { setMode(data._approximate); } catch(_) {}
                        if (data.error) {
                            heatmapDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                            return;
                        }
                        const approxNote = data._approximate ? '<div>Approximate client-side estimate (API unavailable)</div>' : '';
                        heatmapDiv.innerHTML = '<h3>Yearly Heatmap</h3><p>Darker green indicates higher (more optimal) window scores.</p>' + approxNote;
                        const calendar = document.createElement('div');
                        calendar.className = 'calendar-heatmap';
                        heatmapDiv.appendChild(calendar);
                        
                        // Simple calendar heatmap rendering
                        const entries = Object.entries(data.daily_scores).sort((a,b)=> a[0] < b[0] ? -1 : 1);
                        for (const [date, score] of entries) {
                            if (score === null || typeof score === 'undefined') continue;
                            const day = document.createElement('div');
                            day.className = 'heatmap-day';
                            const alpha = Math.max(0.05, Math.min(1, Number(score)));
                            day.style.backgroundColor = `rgba(0, 128, 0, ${alpha})`;
                            day.title = `${date}: ${Number(score).toFixed(4)}`;
                            calendar.appendChild(day);
                        }
                        if (heatmapLegend) {
                            const alphas = [0.1, 0.3, 0.5, 0.7, 0.9];
                            heatmapLegend.innerHTML = '';
                            const low = document.createElement('span'); low.textContent = 'low';
                            heatmapLegend.appendChild(low);
                            alphas.forEach(a => {
                                const sw = document.createElement('span');
                                sw.className = 'swatch';
                                sw.style.backgroundColor = `rgba(0, 128, 0, ${a})`;
                                heatmapLegend.appendChild(sw);
                            });
                            const high = document.createElement('span'); high.textContent = 'high';
                            heatmapLegend.appendChild(high);
                            heatmapLegend.style.display = 'flex';
                        }
                        
                        topWindowsDiv.innerHTML = '<h3>Top 10 Optimal Windows</h3>';
                        const table = document.createElement('table');
                        table.innerHTML = '<thead><tr><th>Date</th><th>Score</th></tr></thead>';
                        const tbody = document.createElement('tbody');
                        data.top_windows.forEach(item => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = item.date;
                            row.insertCell(1).textContent = Number(item.score).toFixed(6);
                        });
                        table.appendChild(tbody);
                        topWindowsDiv.appendChild(table);
                        topWindowsDiv.style.display = 'block';

                    })
                    .catch(error => {
                        heatmapDiv.innerHTML = `<p>Error generating heatmap.</p>`;
                        console.error('Error:', error);
                    });
            });

            // Initialize defaults to now and current year; auto-run initial calculation
            setMode(null);
            try {
                const now = new Date();
                const pad = n => String(n).padStart(2,'0');
                const localISO = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
                datetimeInput.value = localISO;
                yearInput.value = now.getFullYear();
                // Trigger initial calculation for immediate feedback
                calculateBtn.click();
            } catch (e) {
                console.warn('Initialization error:', e);
            }
        });
    </script>
</body>
</html>
